/* * This file is part of the ImageManager package. * * @author (c) Tim Shelburne <tim@dontlookstudios.com> * * For the full copyright and license information, please view the LICENSE * file that was distributed with this source code. */package dls.imagemanager.loaders {		import dls.debugger.Debug;	import dls.imagemanager.IImage;	import dls.imagemanager.loaders.IImageLoader;		import flash.display.Bitmap;	import flash.display.BitmapData;	import flash.display.Loader;	import flash.display.LoaderInfo;	import flash.events.Event;	import flash.net.URLRequest;		import org.osflash.signals.natives.NativeSignal;
		/*	 * A generalized class to handle loading images.	 */	public class ImageLoader implements IImageLoader {				/*=========================================================*		 * PROPERTIES		 *=========================================================*/		 		private var _pendingImages:Vector.<IImage> = new <IImage>[];		private var _nocache:String = "?nocache=" + new Date().valueOf().toString();				/*=========================================================*		 * FUNCTIONS		 *=========================================================*/				public function canHandle(options:Object):Boolean {			return true;		}				/**		 * responds to a load request from the image manager for the given image		 */		public function load(image:IImage, options:Object):void {			_pendingImages.push(image);						var url:String = image.url;						if (!options.hasOwnProperty("cache") || !options.cache) {				url += _nocache;			}						var loader:Loader = new Loader();			loader.name = image.url;			new NativeSignal(loader.contentLoaderInfo, Event.COMPLETE, Event).addOnce(imageLoaded);			Debug.out(" -- Image Manager: Loading " + url + "...", Debug.DETAILS);			loader.load(new URLRequest(url));		}				/**		 * loads an image from any domain with no policy file check, and reloads it to get the byte code		 */		private function imageLoaded(e:Event):void {			Debug.out(" -- Image Manager: " + e.target.loader.name + " loaded...", Debug.DETAILS);			var byteInfo:LoaderInfo = LoaderInfo(e.target);						var reloader:Loader = new Loader();			reloader.name = e.target.loader.name;			reloader.loadBytes(byteInfo.bytes);			Debug.out(" -- Image Manager: Loading bytes for image manipulation on " + e.target.loader.name, Debug.DEBUG);			new NativeSignal(reloader.contentLoaderInfo, Event.COMPLETE, Event).addOnce(imageBytesLoaded);		}				/**		 * responds to the image bytecode loader in order to manipulate image data		 * 		 * thanks to http://www.inklink.co.at/blog/?p=14 for the idea		 */		private function imageBytesLoaded(e:Event):void {			Debug.out( " -- Image Manager: Bytes loaded for image manipulation on " + e.target.loader.name, Debug.DEBUG);			var bitmapData:BitmapData = new BitmapData(e.target.width, e.target.height, true, 0x00000000);			bitmapData.draw(e.target.content);						var bitmap:Bitmap = new Bitmap();			bitmap.bitmapData = bitmapData.clone();			bitmap.smoothing = true;						for each (var image:IImage in _pendingImages) {				if (image.url == e.target.loader.name) {					image.bitmap = bitmap;					_pendingImages.splice(_pendingImages.indexOf(image), 1);				}			}		}	}}